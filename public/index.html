<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Dashboard Viaggi</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
#controls { margin-bottom: 1em; }
#filters { margin-bottom: 1em; }
table { border-collapse: collapse; width: 100%; }
th, td { border: 1px solid #ccc; padding: 6px; }
th { cursor: pointer; background: #eee; }
button { padding: 0.5em 1em; }
</style>
</head>
<body>
<h1>Offerte Viaggi</h1>
<div id="controls">
  <button id="refresh">Aggiorna offerte</button>
  <div id="filters"></div>
</div>
<table id="offers">
<thead>
<tr><th data-field="country">Paese</th><th data-field="name">Struttura</th><th data-field="date">Partenza</th><th data-field="duration">Durata</th><th data-field="airport">Aeroporto</th><th data-field="formula">Tipo</th><th data-field="price">Prezzo</th><th data-field="transfer">Transfer</th></tr>
</thead>
<tbody></tbody>
</table>
<script>
let sortBy = '';
async function loadFilters(){
  const data = await fetch('/api/filters').then(r=>r.json());
  const div = document.getElementById('filters');
  div.innerHTML = '';
  for(const key in data){
    const select = document.createElement('select');
    select.id = key;
    const opt = document.createElement('option');
    opt.value='';
    opt.textContent=`Tutti i ${key}`;
    select.appendChild(opt);
    data[key].forEach(v=>{
      const o = document.createElement('option');
      o.value=v;
      o.textContent=v;
      select.appendChild(o);
    });
    select.onchange = loadOffers;
    div.appendChild(select);
  }
}
async function loadOffers(){
  const params = new URLSearchParams();
  ['country','formula','airport'].forEach(id=>{
    const val = document.getElementById(id)?.value;
    if(val) params.append(id,val);
  });
  if(sortBy) params.append('sortBy', sortBy);
  const data = await fetch('/api/offers?'+params.toString()).then(r=>r.json());
  const tbody = document.querySelector('#offers tbody');
  tbody.innerHTML = '';
  data.forEach(o=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${o.country}</td><td>${o.name}</td><td>${o.date}</td><td>${o.duration}</td><td>${o.airport}</td><td>${o.formula}</td><td>${o.price}</td><td>${o.transfer ? 'si' : 'no'}</td>`;
    tbody.appendChild(tr);
  });
}
document.querySelectorAll('th').forEach(th=>{
  th.onclick = ()=>{ sortBy = th.dataset.field; loadOffers(); };
});
loadFilters().then(loadOffers);
document.getElementById('refresh').onclick = async () => {
  document.getElementById('refresh').disabled = true;
  await fetch('/api/refresh', {method: 'POST'});
  await loadFilters();
  await loadOffers();
  document.getElementById('refresh').disabled = false;
};
</script>
</body>
</html>
